# .github/workflows/auto-review-merge.yml
name: Auto Review and Merge PR

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [main]

jobs:
  auto-review-and-merge:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get PR Info
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            return {
              number: pr.number,
              author: pr.user.login,
              title: pr.title,
              draft: pr.draft,
              mergeable: pr.mergeable,
              head_sha: pr.head.sha
            };

      - name: Add Labels to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prData = ${{ steps.pr-info.outputs.result }};
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prData.number,
              labels: ['auto-review', 'pending-merge', 'vercel-deploy']
            });

      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prData = ${{ steps.pr-info.outputs.result }};
            
            // Adiciona coment√°rio solicitando review do Copilot
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prData.number,
              body: `## ü§ñ Review Autom√°tico Iniciado
              
              @github-copilot review this PR focusing on:
              - Build safety and breaking changes
              - Security vulnerabilities
              - Performance implications
              - Code quality and best practices
              
              **Status:** ‚è≥ Aguardando review autom√°tico
              **Next:** Auto-merge ap√≥s aprova√ß√£o dos checks
              
              ---
              *PR por @${prData.author} ser√° mergeado automaticamente pelo owner ap√≥s aprova√ß√£o.*`
            });

      - name: Wait for Initial Checks
        run: |
          echo "Aguardando checks iniciais..."
          sleep 30

      - name: Check PR Status and Auto-Merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prData = ${{ steps.pr-info.outputs.result }};
            
            // Aguarda um pouco mais para garantir que os checks rodaram
            await new Promise(resolve => setTimeout(resolve, 30000));
            
            // Busca informa√ß√µes atualizadas do PR
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prData.number
            });
            
            console.log(`PR #${prData.number} - Status: ${pr.mergeable_state}`);
            
            // Verifica status dos checks
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            // Verifica se todos os checks passaram
            const checksOk = checks.check_runs.length === 0 || 
                           checks.check_runs.every(check => 
                             check.status === 'completed' && 
                             (check.conclusion === 'success' || check.conclusion === 'neutral')
                           );
            
            const statusesOk = statuses.length === 0 || 
                             statuses.every(status => status.state === 'success');
            
            console.log(`Checks OK: ${checksOk}, Statuses OK: ${statusesOk}`);
            
            // Condi√ß√µes para merge autom√°tico
            const canMerge = !pr.draft && 
                           pr.mergeable && 
                           checksOk && 
                           statusesOk &&
                           pr.mergeable_state !== 'dirty';
            
            if (canMerge) {
              // Atualiza o coment√°rio
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prData.number,
                body: `## ‚úÖ Review Aprovado - Fazendo Merge
                
                **Checks:** ‚úÖ Todos passaram
                **Security:** ‚úÖ Sem problemas detectados
                **Merge:** üöÄ Em progresso...
                
                *Mergeando como ${context.repo.owner} para trigger do deploy.*`
              });
              
              // Faz o merge squash
              try {
                const { data: mergeResult } = await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prData.number,
                  commit_title: `${pr.title} (#${prData.number})`,
                  commit_message: `Merged by auto-review workflow\n\nOriginal author: @${prData.author}\nReviewed and approved automatically`,
                  merge_method: 'squash'
                });
                
                console.log(`‚úÖ PR #${prData.number} mergeado com sucesso!`);
                console.log(`Commit SHA: ${mergeResult.sha}`);
                
                // Coment√°rio de sucesso
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prData.number,
                  body: `## üéâ Merge Conclu√≠do!
                  
                  ‚úÖ **PR mergeado com sucesso**
                  üìù **Commit:** \`${mergeResult.sha.substring(0, 7)}\`
                  üöÄ **Deploy:** Vercel deploy iniciado automaticamente
                  
                  Obrigado @${prData.author} pela contribui√ß√£o!`
                });
                
              } catch (error) {
                console.error('Erro ao fazer merge:', error);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prData.number,
                  body: `## ‚ùå Erro no Merge Autom√°tico
                  
                  N√£o foi poss√≠vel fazer o merge automaticamente.
                  **Erro:** ${error.message}
                  
                  Por favor, fa√ßa o merge manualmente ou verifique os conflitos.`
                });
              }
              
            } else {
              console.log(`PR #${prData.number} n√£o pode ser mergeado automaticamente`);
              console.log(`Draft: ${pr.draft}, Mergeable: ${pr.mergeable}, State: ${pr.mergeable_state}`);
              
              let reason = [];
              if (pr.draft) reason.push("√â um draft");
              if (!pr.mergeable) reason.push("Tem conflitos");
              if (!checksOk) reason.push("Alguns checks falharam");
              if (!statusesOk) reason.push("Alguns status checks falharam");
              if (pr.mergeable_state === 'dirty') reason.push("Branch desatualizada");
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prData.number,
                body: `## ‚è∏Ô∏è Merge Autom√°tico Pausado
                
                **Motivo(s):**
                ${reason.map(r => `- ${r}`).join('\n')}
                
                **Pr√≥ximos passos:**
                - Resolva os problemas acima
                - O merge ser√° tentado automaticamente quando os checks passarem
                
                Ou fa√ßa o merge manualmente quando estiver pronto.`
              });
            }

  # Job separado para reagir a mudan√ßas no PR
  handle-pr-updates:
    runs-on: ubuntu-latest
    if: github.event.action == 'synchronize'
    
    steps:
      - name: PR Updated - Restart Review Process
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## üîÑ PR Atualizado
              
              Novos commits detectados. Reiniciando processo de review autom√°tico...
              
              @github-copilot please review the latest changes in this PR.`
            });
