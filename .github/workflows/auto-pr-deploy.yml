name: Auto PR for Vercel Deploy

on:
  push:
    branches:
      - develop # adicione outras branches se necess치rio
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  check-author-and-create-pr:
    runs-on: ubuntu-latest
    
    # S칩 executa se o commit N츾O for feito pelo dono do reposit칩rio
    if: github.actor != github.repository_owner
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
            git config --local user.email "reis23@discente.ufg.br"
            git config --local user.name "konojoao"
      - name: Get commit info
        id: commit-info
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" $COMMIT_SHA)
          COMMIT_AUTHOR="${{ github.actor }}"
          
          echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit-msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit-author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT

      - name: Create deployment branch
        id: create-branch
        run: |
          BRANCH_NAME="deploy/auto-pr-$(date +%Y%m%d-%H%M%S)"
          
          # Cria nova branch a partir do commit atual
          git checkout -b $BRANCH_NAME
          git push origin $BRANCH_NAME
          
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `游 Deploy: ${{ steps.commit-info.outputs.commit-msg }}`,
              head: '${{ steps.create-branch.outputs.branch-name }}',
              base: 'main',
              body: `## Deploy Autom치tico 游뱄
              
              **Commit Original:** ${{ steps.commit-info.outputs.commit-sha }}
              **Autor:** @${{ steps.commit-info.outputs.commit-author }}
              **Mensagem:** ${{ steps.commit-info.outputs.commit-msg }}
              
              ---
              
              Este PR foi criado automaticamente para trigger do deploy na Vercel.
              
              ### Checklist
              - [ ] Build passa sem erros
              - [ ] Testes passam
              - [ ] Deploy preview est치 funcionando
              
              ### Review Autom치tico
              O GitHub Copilot far치 o review autom치tico deste PR.
              
              **丘멆잺 Este PR ser치 mergeado automaticamente ap칩s aprova칞칚o dos checks.**`,
              draft: false
            });
            
            console.log('PR criado:', pullRequest.html_url);
            return pullRequest.number;

      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.result }};
            
            // Adiciona labels ao PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['auto-deploy', 'vercel-deploy', 'needs-review']
            });
            
            // Solicita review do GitHub Copilot (se configurado)
            // Adiciona coment치rio para trigger do Copilot
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '@github-copilot review this PR for deployment safety'
            });

  # Job separado para fazer merge autom치tico ap칩s checks
  auto-merge:
    needs: check-author-and-create-pr
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Wait for checks
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:deploy/auto-pr-*`
            });
            
            if (prs.length === 0) return;
            
            const pr = prs[0];
            console.log(`Verificando PR #${pr.number}`);
            
            // Aguarda um tempo para os checks rodarem
            await new Promise(resolve => setTimeout(resolve, 30000));
            
            // Verifica status dos checks
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const allPassed = checks.check_runs.every(check => 
              check.status === 'completed' && check.conclusion === 'success'
            );
            
            if (allPassed) {
              // Faz merge do PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                commit_title: `游 Auto-deploy: ${pr.title}`,
                merge_method: 'squash'
              });
              
              console.log(`PR #${pr.number} foi mergeado automaticamente`);
              
              // Remove a branch tempor치ria
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${pr.head.ref}`
              });
              
            } else {
              console.log('Nem todos os checks passaram, PR n칚o ser치 mergeado automaticamente');
            }
